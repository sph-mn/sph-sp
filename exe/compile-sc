#!/bin/sh

# description
# * compiles the sc source code to c
# dependencies
# * sph-sc
# * clang-format

root="$PWD"
sc_dir=source/sc
c_dir="source/c-precompiled"

copy_example_config() {
  # the config file is not versioned so that users can customise it
  if [ ! -f "$sc_dir/main/config.sc" ]
  then
    cp "$sc_dir/main/config.example.sc" "$sc_dir/main/config.sc"
  fi
}

copy_submodules() {
  # copy code files from submodules.
  # to not have the whole submodule repository in the source directory
  sc_lib_dir=submodules/sph-sc-lib/source/sc
  mkdir -p "$sc_dir/foreign/sph" &&
  cp --update --target-directory="$sc_dir/foreign" "$sc_lib_dir/sph.sc" &&
  cp --update --target-directory="$sc_dir/foreign/sph" \
     "$sc_lib_dir/sph/status.sc" "$sc_lib_dir/sph/mi-list.sc" \
     "$sc_lib_dir/sph/imht-set.sc" "$sc_lib_dir/sph/one.sc"
}

compile_sc() {
  # create the c source code
  mkdir -p "$c_dir" &&
  cd "$sc_dir" &&
  find -type f -name "*.sc" -exec sc --parents '{}' "$root/$c_dir" \;
  #cd "$root" &&
  #find "$c_dir" -type f -exec ./exe/format-c -i '{}' \; &&
  #mv "$c_dir/main/sph-db.c" "$c_dir/main/sph-db.h"
}

copy_example_config &&
copy_submodules &&
compile_sc $@
