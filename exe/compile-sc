#!/bin/sh

# description
# * compiles the sc source code to c
# dependencies
# * sph-sc
# * clang-format

root="$PWD"
sc=source/sc
c="source/c-precompiled"

copy_submodules() {
  # copy code files from submodules.
  # to not have the whole submodule repository in the source directory
  scl=submodules/sph-sc-lib/source/sc/main
  mkdir -p "$sc/foreign/sph" &&
  cp --update --target-directory="$sc/foreign" "$scl/sph.sc" &&
  cp --update --target-directory="$sc/foreign/sph" \
    "$scl/status.sc" "$scl/helper.sc" "$scl/memreg.sc" "$scl/float.sc" \
    "$scl/string.sc" "$scl/filesystem.sc" "$scl/quicksort.sc" "$scl/queue.sc" \
    "$scl/thread-pool.sc" "$scl/futures.sc" "$scl/spline-path-h.sc" "$scl/spline-path.sc" \
    "$scl/types.sc" "$scl/random-h.sc" "$scl/random.sc"
}

compile_sc() {
  # create the c source code
  mkdir -p "$c" &&
  cd "$sc" &&
  find -type f -name "*.sc" -exec sc --parents '{}' "$root/$c" \;
  cd "$root" &&
  find "$c" -type f -exec ./exe/format-c -i '{}' \; &&
  mv "$c/main/sph-sp.c" "$c/main/sph-sp.h"
}

copy_submodules &&
compile_sc $@
